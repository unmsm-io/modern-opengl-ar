---
import TableOfContents from "../components/TableOfContents.astro";
import BaseLayout from "./BaseLayout.astro";
import { WORKSHOP_CONFIG } from "../config/workshop";
import { ChevronLeft, Clock, GitBranch, ExternalLink } from "lucide-astro";

interface Props {
  frontmatter: {
    id: string; // step0-setup
    tag: string; // git tag
    title: string;
    summary: string;
    durationMin: number; // minutos estimados
    files: string[];
    path: string; // ruta relativa para href
    author: string;
    authorImageUrl: string;
    pubDate: string;
  };
  id: string;
  headings: {
    slug: string;
    text: string;
    depth: number;
  }[];
}

const { frontmatter, id, headings } = Astro.props;

// Find the corresponding step in WORKSHOP_CONFIG for additional info
const configStep = WORKSHOP_CONFIG.steps.find(
  (step) => step.id === frontmatter.id,
);

// Get step number from the array
const stepIndex = WORKSHOP_CONFIG.steps.findIndex(
  (step) => step.id === frontmatter.id,
);
const stepNumber = stepIndex >= 0 ? stepIndex + 1 : null;

// Format date
const formattedDate = new Date(frontmatter.pubDate).toLocaleDateString(
  "es-PE",
  {
    year: "numeric",
    month: "long",
    day: "numeric",
  },
);

const isoDate = new Date(frontmatter.pubDate).toISOString();

// Navigation helpers
const prevStep = stepIndex > 0 ? WORKSHOP_CONFIG.steps[stepIndex - 1] : null;
const nextStep =
  stepIndex < WORKSHOP_CONFIG.steps.length - 1
    ? WORKSHOP_CONFIG.steps[stepIndex + 1]
    : null;
---

<BaseLayout title={frontmatter.title} description={frontmatter.summary}>
  <article
    class="prose dark:prose-invert max-w-none
    prose-table:border-collapse prose-table:w-full
    prose-thead:border-b prose-thead:border-neutral-200 dark:prose-thead:border-neutral-700
    prose-th:py-2 prose-th:px-4 prose-th:text-left prose-th:font-semibold prose-th:bg-neutral-50 dark:prose-th:bg-neutral-800
    prose-td:py-2 prose-td:px-4 prose-td:border-b prose-td:border-neutral-200 dark:prose-td:border-neutral-700
    prose-tr:hover:bg-neutral-50 dark:prose-tr:hover:bg-neutral-800/50
    prose-tr:transition-colors prose-tr:duration-200"
    itemscope
    itemtype="https://schema.org/Article"
  >
    <meta itemprop="datePublished" content={isoDate} />
    <meta itemprop="dateModified" content={isoDate} />
    <meta
      itemprop="keywords"
      content="OpenGL, Realidad Aumentada, C++, Workshop"
    />

    <!-- Header Section -->
    <div class="max-w-4xl mx-auto !mb-8">
      {
        stepNumber && (
          <div class="flex justify-center pt-10 pb-2">
            <span class="px-3 py-1 text-xs font-semibold border border-neutral-300 dark:border-neutral-600 text-black dark:text-white bg-white dark:bg-neutral-800 rounded-full">
              Paso {stepNumber - 1}
            </span>
          </div>
        )
      }

      <h1
        class="flex justify-center text-5xl leading-tight tracking-tight !mx-auto !text-center font-semibold mb-4 pt-4"
        itemprop="headline"
      >
        {frontmatter.title}
      </h1>

      <p
        class="text-xl text-neutral-600 dark:text-neutral-300 text-center mb-6 !mx-auto max-w-3xl"
      >
        {frontmatter.summary}
      </p>

      <!-- Meta Information -->
      <div
        class="flex items-center justify-center gap-6 text-sm text-neutral-500 dark:text-neutral-400 mb-6"
      >
        <div class="flex items-center gap-2">
          <img
            src={frontmatter.authorImageUrl}
            alt={frontmatter.author}
            class="size-6 !m-0 rounded-full"
            itemprop="image"
          />
          <span
            class="!m-0 font-medium"
            itemprop="author"
            itemscope
            itemtype="https://schema.org/Person"
          >
            <meta itemprop="name" content={frontmatter.author} />
            {frontmatter.author}
          </span>
        </div>

        <span class="text-neutral-400">·</span>

        <div class="flex items-center gap-1">
          <Clock class="w-4 h-4" />
          <span>{frontmatter.durationMin} min</span>
        </div>

        <span class="text-neutral-400">·</span>

        <time
          datetime={isoDate}
          class="text-neutral-500 dark:text-neutral-400"
          itemprop="datePublished"
        >
          {formattedDate}
        </time>
      </div>

      <!-- Git Tag and Repository Links -->
      <div class="flex items-center justify-center gap-4 mb-8">
        <div
          class="flex items-center gap-2 bg-neutral-100 dark:bg-neutral-800 px-3 py-2 rounded"
        >
          <GitBranch class="w-4 h-4 text-neutral-500" />
          <span class="text-sm text-neutral-600 dark:text-neutral-400"
            >Tag:</span
          >
          <code
            class="text-sm font-mono text-neutral-700 dark:text-neutral-300"
          >
            {frontmatter.tag}
          </code>
        </div>

        <a
          href={`${WORKSHOP_CONFIG.repository.url}/tree/${frontmatter.tag}`}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors text-sm font-medium no-underline"
        >
          <ExternalLink class="w-4 h-4" />
          Ver código
        </a>

        {
          frontmatter.path && (
            <a
              href={`${WORKSHOP_CONFIG.repository.url}/tree/${frontmatter.tag}/${frontmatter.path}`}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 border border-neutral-300 dark:border-neutral-600 text-neutral-700 dark:text-neutral-300 px-4 py-2 rounded hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors text-sm no-underline"
            >
              <ExternalLink class="w-4 h-4" />
              Directorio
            </a>
          )
        }
      </div>

      <!-- Files Section -->
      {
        frontmatter.files && frontmatter.files.length > 0 && (
          <div class="bg-neutral-50 dark:bg-neutral-800/50 border border-neutral-200 dark:border-neutral-700 rounded-lg p-4 mb-8">
            <h3 class="text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3 !mt-0">
              Archivos principales del paso:
            </h3>
            <div class="flex flex-wrap gap-2">
              {frontmatter.files.map((file) => (
                <code class="bg-white dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 px-3 py-1 rounded text-sm border border-neutral-200 dark:border-neutral-600">
                  {file}
                </code>
              ))}
            </div>
          </div>
        )
      }
    </div>

    <!-- Content -->
    <div
      class="space-y-6 max-w-4xl mx-auto scroll-smooth"
      itemprop="articleBody"
    >
      <TableOfContents headings={headings} />
      <slot />
    </div>

    <!-- Step Navigation -->
    <div class="mt-12 pt-6 border-t border-neutral-200 dark:border-neutral-800">
      <div class="flex items-center justify-between max-w-4xl mx-auto">
        <div class="flex items-center gap-4">
          <a
            href="/steps"
            class="text-blue-600 dark:text-blue-400 hover:underline inline-flex items-center gap-1 text-sm"
          >
            <ChevronLeft class="w-3.5 h-3.5" />
            Todos los pasos
          </a>

          {
            prevStep && (
              <a
                href={`/steps/${prevStep.id}`}
                class="text-neutral-600 dark:text-neutral-400 hover:text-blue-600 dark:hover:text-blue-400 hover:underline inline-flex items-center gap-1 text-sm"
              >
                ← {prevStep.title}
              </a>
            )
          }
        </div>

        {
          nextStep && (
            <a
              href={`/steps/${nextStep.id}`}
              class="text-neutral-600 dark:text-neutral-400 hover:text-blue-600 dark:hover:text-blue-400 hover:underline inline-flex items-center gap-1 text-sm"
            >
              {nextStep.title} →
            </a>
          )
        }
      </div>
    </div>
  </article>
</BaseLayout>
